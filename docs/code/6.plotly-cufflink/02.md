---
title: Choropleth for geographical plot
sidebar_position: 33
---

# Choropleth Maps with Plotly 5.x (Modern API)

Below is a clean, current workflow for **state-level (USA)** and **global**
choropleth maps using Plotly **Express** and, where needed, low-level **Graph
Objects**. No Cufflinks, no legacy offline setup.

---

## 0) Setup

```bash
pip install -U plotly pandas numpy kaleido
```

```python
import numpy as np
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
print("plotly", __import__("plotly").__version__)
```

---

## 1) Quick USA choropleth (state abbreviations)

Use two columns:

- `code` → two-letter state codes (`"CA"`, `"NY"`, …)
- `value` → numeric metric to color by

```python
usa = pd.DataFrame({
    "code": ["AZ", "CA", "NY"],
    "value": [1.0, 2.0, 3.0],
    "hover": ["Arizona", "California", "New York"]
})

fig = px.choropleth(
    usa,
    locations="code",
    locationmode="USA-states",
    color="value",
    hover_name="hover",
    scope="usa",                             # zooms to USA
    color_continuous_scale="YlOrRd",         # e.g. "Greens", "Viridis", "RdBu"
    labels={"value": "Metric"}
)

# Styling (borders, lakes, projection)
fig.update_traces(marker_line_color="black", marker_line_width=0.5)
fig.update_geos(
    showlakes=True,
    lakecolor="rgb(85,173,240)",
    projection_type="albers usa",
    fitbounds="locations"
)
fig.update_layout(
    title="Example USA Choropleth",
    coloraxis_colorbar_title="Units"
)

fig.show()
```

### Notes

- `locationmode="USA-states"` expects **uppercase** USPS codes. Anything unknown
  renders as missing.
- `scope="usa"` sets the geographic view; `projection_type="albers usa"` gives a
  good US projection.
- Customize the colorbar title via `coloraxis_colorbar_title`.

---

## 2) Real dataset example (U.S. Agriculture Exports)

If you have a CSV like `2011_us_ag_exports.csv` with columns `code`, `state`,
`total exports`, and `text`:

```python
df = pd.read_csv("2011_us_ag_exports.csv")   # adjust path
fig = px.choropleth(
    df,
    locations="code",
    locationmode="USA-states",
    color="total exports",
    scope="usa",
    hover_name="state",
    hover_data={"text": True, "code": False},   # show custom text, hide code
    color_continuous_scale="YlOrRd",
    labels={"total exports": "Millions USD"}
)

fig.update_traces(marker_line_color="white", marker_line_width=0.8)
fig.update_geos(showlakes=True, lakecolor="rgb(85,173,240)", projection_type="albers usa")
fig.update_layout(title="2011 U.S. Agriculture Exports by State")

fig.show()
```

Tip: if you want the **borders thicker/darker**, change
`marker_line_color`/`marker_line_width`.

---

## 3) World choropleth (ISO-3 country codes)

For global data, use ISO-3 country codes (e.g., `USA`, `IND`, `DEU`). A
convenient demo is Gapminder:

```python
gap = px.data.gapminder().query("year == 2007")

fig = px.choropleth(
    gap, locations="iso_alpha", color="lifeExp",
    hover_name="country", projection="natural earth",
    color_continuous_scale="Viridis",
    labels={"lifeExp": "Life Expectancy"}
)
fig.update_layout(title="Life Expectancy (2007)")
fig.show()
```

Parameter hints:

- `projection`: `"natural earth"`, `"equirectangular"`, `"mercator"`, etc.
- For divergent data, try `"RdBu"`/`"Picnic"` and set `range_color=(min, max)`.

---

## 4) County or arbitrary regions (GeoJSON workflow)

When your regions aren’t covered by `locationmode`, pass a **GeoJSON** and a key
column:

```python
# geojson: features with properties like {"id": "06037"} for LA County FIPS
# df must have a column (e.g., "fips") matching feature ids.
fig = px.choropleth(
    df, geojson=geojson_obj, locations="fips", color="metric",
    color_continuous_scale="Blues",
    labels={"metric": "Value"}
)
fig.update_geos(fitbounds="locations", visible=False)
fig.show()
```

Key points:

- `locations` must **exactly match** the GeoJSON feature IDs or the property you
  set via `featureidkey="properties.<field>"`.
- `visible=False` hides the base world map so only shapes render.

---

## 5) Advanced hover and formatting

```python
fig = px.choropleth(
    usa, locations="code", locationmode="USA-states", color="value",
    scope="usa", color_continuous_scale="YlGnBu",
    custom_data=["hover", "value"]
)

fig.update_traces(
    hovertemplate="<b>%{customdata[0]}</b><br>" +
                  "Value: %{customdata[1]:.2f}<extra></extra>"
)
fig.update_layout(title="Custom hovertemplate")
fig.show()
```

- `custom_data` passes arbitrary columns to the hover template.
- `: .2f` formats numbers; `<extra></extra>` removes the trace name box.

---

## 6) Saving and sharing

```python
# Self-contained interactive HTML
fig.write_html("map.html", include_plotlyjs="cdn")

# Static images (needs kaleido)
fig.write_image("map.png", width=1400, height=900, scale=2)
```

---

## 7) Troubleshooting checklist

- **Blank shapes**: check `locations` spelling/case; for USA, codes must be USPS
  2-letter; for world, use ISO-3.
- **Wrong geography**: set `scope="usa"` for US or remove it for world; for
  counties/regions, use GeoJSON.
- **Color not applied**: ensure the `color` column is **numeric** for continuous
  scales (or specify a discrete mapping).
- **Projection/zoom**: `fig.update_geos(fitbounds="locations")` zooms to your
  data; for US maps, set `projection_type="albers usa"`.
- **Missing values**: by default they appear gray; control with
  `fig.update_traces(zmin=..., zmax=...)` or fill NaNs before plotting.

---

## 8) Minimal API recap

- **State map**:
  `px.choropleth(df, locations="code", locationmode="USA-states", color="value", scope="usa")`
- **World map**: `px.choropleth(df, locations="iso_alpha", color="metric")`
- **Borders**:
  `fig.update_traces(marker_line_color="black", marker_line_width=0.5)`
- **Lakes + projection**:
  `fig.update_geos(showlakes=True, lakecolor="rgb(85,173,240)", projection_type="albers usa")`
- **Colorbar title**: `fig.update_layout(coloraxis_colorbar_title="Your Title")`

# World Choropleth Maps with Plotly 5.x (International Scale)

A concise, modern workflow for building **interactive world choropleth maps**
with Plotly **Express** (no Cufflinks, no legacy offline setup).

---

## 1) Install & import

```bash
pip install -U plotly pandas numpy kaleido
```

```python
import numpy as np
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go  # optional fine-grained tweaks
print("plotly", __import__("plotly").__version__)
```

---

## 2) Data requirements

Minimum columns:

- **ISO-3 country code** (e.g., `USA`, `IND`, `DEU`) → we’ll call it `iso3`
- **Metric** to color by (e.g., GDP in billions) → `gdp_bil`
- Optional: **Country name** → `country` (for hover)

If your CSV has different names, rename them once:

```python
df = pd.read_csv("2014_world_gdp.csv")  # adjust path
# example original columns: "Country Name", "GDP (Billions)", "CODE"
df = df.rename(columns={
    "Country Name": "country",
    "GDP (Billions)": "gdp_bil",
    "CODE": "iso3"
})
# ensure types are clean
df["iso3"] = df["iso3"].astype(str).str.upper().str.strip()
df["gdp_bil"] = pd.to_numeric(df["gdp_bil"], errors="coerce")
df = df.dropna(subset=["iso3", "gdp_bil"])
```

> Tip Plotly’s built-in world geography maps use **ISO-3** codes. If you only
> have names, convert them once (e.g., in your preprocessing) so maps render
> reliably.

---

## 3) First world choropleth

```python
fig = px.choropleth(
    df,
    locations="iso3",                 # ISO-3 codes
    color="gdp_bil",                  # numeric metric
    hover_name="country",             # label on hover
    color_continuous_scale="YlOrRd",  # try also: "Viridis", "Blues", "RdBu"
    projection="natural earth",       # pleasant default world projection
    labels={"gdp_bil": "GDP (billions USD)"},
    title="2014 Global GDP"
)
fig.show()
```

**What’s happening**

- `locations="iso3"` matches Plotly’s country shapes.
- `color=` is continuous by default; Plotly draws a colorbar.
- `projection=` chooses the globe projection directly in Express.

---

## 4) Polishing borders, oceans, and fit

```python
# Thin black borders between countries
fig.update_traces(marker_line_color="black", marker_line_width=0.3)

# Fit the viewport and style the globe
fig.update_geos(
    fitbounds="locations",
    showcountries=True,
    showocean=True, oceancolor="rgb(230, 245, 255)",
    showland=True,  landcolor="rgb(240, 240, 240)"
)

# Colorbar title and margins
fig.update_layout(
    coloraxis_colorbar_title="Billions USD",
    margin=dict(l=0, r=0, t=50, b=0)
)

fig.show()
```

---

## 5) Better hovers for big numbers

```python
fig = px.choropleth(
    df,
    locations="iso3",
    color="gdp_bil",
    hover_name="country",
    custom_data=["country", "gdp_bil"],
    color_continuous_scale="YlOrRd",
    projection="natural earth",
    title="2014 Global GDP"
)

fig.update_traces(
    hovertemplate="<b>%{customdata[0]}</b><br>" +
                  "GDP: %{customdata[1]:,.0f} B USD" +
                  "<extra></extra>"
)
fig.update_layout(coloraxis_colorbar_title="Billions USD")
fig.show()
```

- `custom_data` lets you format hover labels precisely.
- `:,.0f` adds thousands separators and 0 decimals.

---

## 6) Handling skew (optional log coloring)

GDP is heavily skewed. Two common approaches:

**A) Log transform before coloring**

```python
df["gdp_log10"] = np.log10(df["gdp_bil"].clip(lower=1))
fig = px.choropleth(
    df, locations="iso3", color="gdp_log10",
    hover_name="country",
    color_continuous_scale="YlOrRd",
    projection="natural earth",
    labels={"gdp_log10": "log10(GDP B USD)"},
    title="2014 Global GDP (log scale)"
)
fig.show()
```

**B) Fix the color range**

```python
vmin, vmax = df["gdp_bil"].quantile([0.05, 0.95])
fig = px.choropleth(
    df, locations="iso3", color="gdp_bil",
    hover_name="country",
    color_continuous_scale="YlOrRd",
    range_color=(vmin, vmax),
    projection="natural earth",
    title="2014 Global GDP (5–95% clipped)"
)
fig.show()
```

---

## 7) Trying different projections

```python
for proj in ["natural earth", "equirectangular", "mercator",
             "orthographic", "stereographic", "miller", "robinson"]:
    fig = px.choropleth(
        df, locations="iso3", color="gdp_bil", hover_name="country",
        color_continuous_scale="YlOrRd", projection=proj,
        title=f"2014 Global GDP — {proj.title()} projection"
    )
    fig.update_traces(marker_line_color="black", marker_line_width=0.3)
    fig.show()
```

---

## 8) Saving and sharing

```python
# Interactive HTML (self-contained)
fig.write_html("global_gdp_2014.html", include_plotlyjs="cdn")

# Static images (requires kaleido)
fig.write_image("global_gdp_2014.png", width=1400, height=800, scale=2)
fig.write_image("global_gdp_2014.pdf")
```

---

## 9) Troubleshooting

- **Blank countries** → the `iso3` code didn’t match Plotly’s shapes. Ensure
  valid ISO-3 strings (upper-case).
- **NaNs not colored** → fill or drop missing `gdp_bil`; control missing color
  with `fig.update_traces(marker=dict(line_color=...))` and
  `fig.update_layout(coloraxis_showscale=True)`.
- **Colorbar looks odd** → bind numeric range with `range_color=(min, max)` or
  use a log transform.
- **Performance** → world choropleths are generally light; the bottleneck is
  usually notebook rendering, not data size.

---

## 10) Minimal template (copy/paste)

```python
def world_choropleth(df, iso_col="iso3", value_col="gdp_bil", name_col="country",
                     title="World Choropleth", scale="YlOrRd", projection="natural earth"):
    df = df.rename(columns={iso_col: "iso3", value_col: "val", name_col: "name"})
    df["iso3"] = df["iso3"].astype(str).str.upper().str.strip()
    df["val"]  = pd.to_numeric(df["val"], errors="coerce")
    df = df.dropna(subset=["iso3", "val"])

    fig = px.choropleth(
        df, locations="iso3", color="val", hover_name="name",
        color_continuous_scale=scale, projection=projection, title=title
    )
    fig.update_traces(marker_line_color="black", marker_line_width=0.3)
    fig.update_geos(fitbounds="locations", showocean=True, oceancolor="rgb(230,245,255)")
    fig.update_layout(coloraxis_colorbar_title=str(value_col))
    return fig

# usage:
# fig = world_choropleth(df, iso_col="CODE", value_col="GDP (Billions)", name_col="Country Name",
#                        title="2014 Global GDP")
# fig.show()
```
